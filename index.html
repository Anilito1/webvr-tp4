<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TP4 - WebVR - Exercice 1</title>
    <!-- A-Frame stable -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <!-- Physics system (cannon-es) -->
  <script src="https://cdn.jsdelivr.net/npm/aframe-physics-system@4.0.1/dist/aframe-physics-system.min.js"></script>
    <script src="./src/controls.js"></script>
  <script src="./src/grabber.js"></script>
    <script src="./src/gun.js"></script>
  <script src="./src/targets.js"></script>
    <style>
      html, body { height: 100%; margin: 0; }
      .hud { position: absolute; top: 8px; left: 8px; color: white; font-family: sans-serif; z-index: 10; }
      .hud code { background: rgba(0,0,0,.35); padding: 2px 6px; border-radius: 4px; }
    </style>
  </head>
  <body>
  <div class="hud">VR: Stick G déplacement | Stick D rotation (snap) | Triggers: grab/tirer | Desktop: E prendre/poser, Clic/F tirer | Score: <span id="score">0</span> | Safe: ajouter ?safe=1 si freeze<br><span id="dbg"></span></div>

  <a-scene id="scene" renderer="antialias: true; shadowMap.enabled: true; physicallyCorrectLights: true; colorManagement: true" physics="gravity: -9.81; broadphase: SAP; allowSleep: true" webxr="optionalFeatures: local-floor, bounded-floor" background="color: #202630">
      <a-assets id="assets">
        <!-- Optionally place new weapon model (convert your FBX to glb and put in assets/) -->
        <!-- Example: <a-asset-item id="weaponModel" src="./assets/M4A1.glb"></a-asset-item> -->
      </a-assets>
      <!-- LUMIÈRES -->
  <a-entity light="type: ambient; color: #BBB; intensity: 0.4"></a-entity>
  <a-entity id="dirLight" position="2 4 1" light="type: directional; color: #fff; intensity: 1.0; castShadow: true; shadowCameraVisible: false"></a-entity>

      <!-- SOL -->
  <!-- SOL solide (box) pour éviter les traversées -->
  <a-box position="0 -0.05 0" width="40" depth="40" height="0.1" color="#556" material="metalness: 0.2; roughness: 0.8" shadow="receive: true" static-body="shape: box; friction: 0.6; restitution: 0"></a-box>

      <!-- OBJETS 3D -->
  <!-- Cibles fixes supplémentaires: carré et rond du début -->
  <a-box id="cube" class="target grabbable" position="-3 1.2 -6" depth="1" height="1" width="1" color="#4CC3D9" material="metalness: 0.1; roughness: 0.7" shadow="cast: true; receive: true" dynamic-body="shape: box; mass: 1" target-hit></a-box>
  <a-sphere id="sphere" class="target grabbable" position="3 1.75 -6" radius="1.25" color="#EF2D5E" material="metalness: 0.2; roughness: 0.5" shadow="cast: true; receive: true" dynamic-body="shape: sphere; mass: 1.5" target-hit></a-sphere>
  <a-cylinder class="grabbable" position="0 2.0 -6" radius="0.5" height="1.5" color="#FFC65D" material="metalness: 0.3; roughness: 0.6" shadow="cast: true; receive: true" dynamic-body="shape: box; mass: 1; linearDamping: 0.01; angularDamping: 0.01"></a-cylinder>

  <!-- Arme GLB (proche du joueur) -->
  <a-entity id="gun" class="grabbable" position="0.3 1.4 -0.6" vr-gun="muzzleOffset: 0 0 -0.35; speed: 12; debug: false" geometry="primitive: box; depth: 0.32; height: 0.14; width: 0.38" material="color: #777; opacity: 0.002; transparent: true" dynamic-body="shape: box; mass: 0.5">
    <a-entity id="gunModel" gltf-model="url(./assets/pistol.glb)" scale="0.75 0.75 0.75" rotation="0 90 0"></a-entity>
      </a-entity>

  <!-- Spawner de cibles (mêmes emplacements à chaque vague) -->
  <a-entity id="targetsRoot" position="0 0 0" target-spawner="delay: 3000; slots: -4 1.2 -8, -2 1.2 -8, 0 1.2 -8, 2 1.2 -8, 4 1.2 -8, -3 2.2 -10, -1 2.2 -10, 1 2.2 -10, 3 2.2 -10"></a-entity>

  <!-- RIG + CAMÉRA + CONTRÔLEURS -->
  <a-entity id="rig" position="0 1.6 3" thumbstick-move-rotate>
    <a-entity id="head" position="0 0 0" camera="near: 0.01" look-controls="pointerLockEnabled: false" wasd-controls-enabled="false">
      <!-- Simple reticle for desktop aiming (tiny white ring) -->
      <a-entity id="reticle" position="0 0 -1" geometry="primitive: ring; radiusInner: 0.002; radiusOuter: 0.004" material="color: #fff; shader: flat; side: double; opacity: 0.85"></a-entity>
    </a-entity>

  <!-- Contrôleur gauche (Quest 3) -->
  <a-entity id="leftHand" laser-controls="hand: left" raycaster="objects: .grabbable; far: 10" controller-grab="hand: left; radius: 0.5; useTrigger: false">
    <a-sphere radius="0.02" color="#66ccff"></a-sphere>
  </a-entity>

  <!-- Contrôleur droit (Quest 3) -->
  <a-entity id="rightHand" laser-controls="hand: right" raycaster="objects: .grabbable; far: 10" controller-grab="hand: right; radius: 0.5; useTrigger: false">
    <a-sphere radius="0.02" color="#ff9966"></a-sphere>
  </a-entity>
      </a-entity>

      <!-- SKY -->
  <a-sky color="#223"></a-sky>
  <!-- In-VR floating hints -->
  <a-entity position="0 2.2 1.2" text="value: Stick G = Move | Stick D = Snap Turn | Grip/Trigger = Grab | Trigger arme = Tirer; align: center; width: 4" rotation="0 180 0"></a-entity>
    </a-scene>
    <script>
      const scene = document.getElementById('scene');
      const params = new URLSearchParams(location.search);
      const safe = params.get('safe') === '1';
      const debug = params.get('debug') === '1';
      const perf = params.get('perf') === '1';
      if (safe) {
        // Disable heavy effects in safe mode
        scene.setAttribute('fog', 'enabled: false');
        scene.setAttribute('renderer', 'shadowMap.enabled: false');
        const dl = document.getElementById('dirLight');
        if (dl) dl.setAttribute('light', 'castShadow: false');
        const dbg = document.getElementById('dbg');
        if (dbg) dbg.style.display = 'none';
      }
      if (perf) {
        // Extreme perf mode: remove shadows & lower pixel ratio
        scene.renderer && (scene.renderer.setPixelRatio(0.7));
        const dl = document.getElementById('dirLight');
        if (dl) dl.setAttribute('light', 'intensity: 0.8; castShadow: false');
        console.log('[Perf] mode actif');
      }
      // Dynamic weapon swap via ?weapon=FILENAME (without extension) expects ./assets/FILENAME.glb
      // Default to AK47 if none specified.
      let weaponName = params.get('weapon') || 'AK47';
      (async ()=>{
        const gm = document.getElementById('gunModel');
        if (!gm) return;
        const path = `./assets/${weaponName}.glb`;
        let exists = true;
        try {
          const res = await fetch(path, { method: 'HEAD' });
          if (!res.ok) exists = false;
        } catch(e){ exists = false; }
        if (!exists) {
          console.warn('[Weapon] Fichier', path, 'introuvable. Fallback pistol.glb');
          weaponName = 'pistol';
        }
        const finalPath = `./assets/${weaponName}.glb`;
        console.log('[Weapon] Chargement', finalPath);
        gm.setAttribute('gltf-model', `url(${finalPath})`);
        if (/m4|ak|rifle|scar|awp|shotgun|vector|mp5|mp7/i.test(weaponName)) {
          gm.setAttribute('scale', '0.4 0.4 0.4');
          // Slight adjust for longer rifles (raise a bit)
          gm.setAttribute('position', '0 0.02 0');
        } else {
          gm.setAttribute('scale', '0.75 0.75 0.75');
          gm.removeAttribute('position');
        }
      })();
      if (debug) {
        const gun = document.getElementById('gun');
        if (gun) {
          const v = gun.getAttribute('vr-gun') || {};
          gun.setAttribute('vr-gun', Object.entries(v).map(([k,val])=>`${k}: ${val}`).join('; ') + '; debug: true');
        }
        const right = document.getElementById('rightHand');
        if (right) {
          ['triggerdown','gripdown','squeezestart','selectstart'].forEach(ev=>{
            right.addEventListener(ev, ()=>console.log('[RightHand event]', ev));
          });
        }
      }
      scene.addEventListener('enter-vr', ()=>{
        console.log('[VR] enter-vr');
      });
      scene.addEventListener('loaded', ()=>{
        console.log('[Scene] loaded');
      });
      // Simple frame stall watchdog: if no RAF for >1200ms, show alert tip once
      (function(){
        let last = performance.now();
        let warned = false;
        function tick(){
          const now = performance.now();
            const gap = now - last;
            if (!warned && gap > 1200) {
              warned = true;
              console.warn('[Watchdog] Long frame gap ('+Math.round(gap)+'ms). Essayez ?safe=1 ou ?perf=1 ou ?lite=1');
              const hud = document.getElementById('dbg');
              if (hud) hud.textContent = (hud.textContent + ' | Lag détecté: utiliser ?safe=1 ou ?perf=1').trim();
            }
          last = now;
          requestAnimationFrame(tick);
        }
        requestAnimationFrame(tick);
      })();
    </script>
  </body>
</html>
