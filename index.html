<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TP4 - WebVR - Exercice 1</title>
    <!-- A-Frame stable -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <!-- Physics system (cannon-es) -->
  <script src="https://cdn.jsdelivr.net/npm/aframe-physics-system@4.0.1/dist/aframe-physics-system.min.js"></script>
    <script src="./src/controls.js"></script>
  <script src="./src/grabber.js"></script>
    <style>
      html, body { height: 100%; margin: 0; }
      .hud { position: absolute; top: 8px; left: 8px; color: white; font-family: sans-serif; z-index: 10; }
      .hud code { background: rgba(0,0,0,.35); padding: 2px 6px; border-radius: 4px; }
    </style>
  </head>
  <body>
  <div class="hud">Joystick gauche: déplacement | Joystick droit: rotation | Clavier: ZQSD/WASD + souris<br><span id="dbg"></span></div>

  <a-scene id="scene" renderer="antialias: true; shadowMap.enabled: true; physicallyCorrectLights: true; colorManagement: true" physics="gravity: -9.81; broadphase: SAP; allowSleep: true" webxr="optionalFeatures: local-floor, bounded-floor" background="color: #202630">
      <!-- LUMIÈRES -->
  <a-entity light="type: ambient; color: #BBB; intensity: 0.4"></a-entity>
  <a-entity id="dirLight" position="2 4 1" light="type: directional; color: #fff; intensity: 1.0; castShadow: true; shadowCameraVisible: false"></a-entity>

      <!-- SOL -->
  <!-- SOL solide (box) pour éviter les traversées -->
  <a-box position="0 -0.05 0" width="40" depth="40" height="0.1" color="#556" material="metalness: 0.2; roughness: 0.8" shadow="receive: true" static-body="shape: box; friction: 0.6; restitution: 0"></a-box>

      <!-- OBJETS 3D -->
  <a-box id="cube" class="grabbable" position="-1 1.6 -3" depth="1" height="1" width="1" color="#4CC3D9" material="metalness: 0.1; roughness: 0.7" shadow="cast: true; receive: true" dynamic-body="shape: box; mass: 1"></a-box>
  <a-sphere id="sphere" class="grabbable" position="1 2.2 -3" radius="1.25" color="#EF2D5E" material="metalness: 0.2; roughness: 0.5" shadow="cast: true; receive: true" dynamic-body="shape: sphere; mass: 1"></a-sphere>
  <a-cylinder class="grabbable" position="0 2.0 -6" radius="0.5" height="1.5" color="#FFC65D" material="metalness: 0.3; roughness: 0.6" shadow="cast: true; receive: true" dynamic-body="shape: box; mass: 1; linearDamping: 0.01; angularDamping: 0.01"></a-cylinder>

  <!-- RIG + CAMÉRA + CONTRÔLEURS -->
  <a-entity id="rig" position="0 1.6 3" thumbstick-move-rotate>
  <a-entity id="head" position="0 0 0" camera look-controls="pointerLockEnabled: false" wasd-controls-enabled="false"></a-entity>

  <!-- Contrôleur gauche (Quest 3) -->
  <a-entity id="leftHand" laser-controls="hand: left" raycaster="objects: .grabbable; far: 10" controller-grab="hand: left; radius: 0.35">
    <a-sphere radius="0.02" color="#66ccff"></a-sphere>
  </a-entity>

  <!-- Contrôleur droit (Quest 3) -->
  <a-entity id="rightHand" laser-controls="hand: right" raycaster="objects: .grabbable; far: 10" controller-grab="hand: right; radius: 0.35">
    <a-sphere radius="0.02" color="#ff9966"></a-sphere>
  </a-entity>
      </a-entity>

      <!-- SKY -->
  <a-sky color="#223"></a-sky>
    </a-scene>
    <script>
      const scene = document.getElementById('scene');
      const params = new URLSearchParams(location.search);
      const safe = params.get('safe') === '1';
      if (safe) {
        // Disable heavy effects in safe mode
        scene.setAttribute('fog', 'enabled: false');
        scene.setAttribute('renderer', 'shadowMap.enabled: false');
        const dl = document.getElementById('dirLight');
        if (dl) dl.setAttribute('light', 'castShadow: false');
        const dbg = document.getElementById('dbg');
        if (dbg) dbg.style.display = 'none';
      }
      scene.addEventListener('enter-vr', ()=>{
        console.log('[VR] enter-vr');
      });
      scene.addEventListener('loaded', ()=>{
        console.log('[Scene] loaded');
      });
    </script>
  </body>
</html>
