<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TP4 - WebVR - Exercice 1</title>
    <!-- A-Frame stable -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <!-- Physique retirée pour simplifier (plus d'erreurs addVectors). Activer à nouveau facilement si besoin. -->
    <script>console.log('[Init] Mode simplifié: pas de physique');</script>
    <script src="./src/controls.js"></script>
  <script src="./src/grabber.js"></script>
    <script src="./src/gun.js"></script>
  <script src="./src/targets.js"></script>
    <style>
      html, body { height: 100%; margin: 0; }
      .hud { position: absolute; top: 8px; left: 8px; color: white; font-family: sans-serif; z-index: 10; }
      .hud code { background: rgba(0,0,0,.35); padding: 2px 6px; border-radius: 4px; }
    </style>
  </head>
  <body>
  <div class="hud">VR: Grip/Squeeze = Prendre | Trigger (tenir) = Tirer | Stick G déplacer | Stick D rotation | Desktop: E prendre/poser, Clic/F tirer | Score: <span id="score">0</span> | (mode sans physique)<br><span id="dbg"></span></div>

  <a-scene id="scene" renderer="antialias: true; shadowMap.enabled: true; physicallyCorrectLights: true; colorManagement: true" webxr="optionalFeatures: local-floor, bounded-floor" background="color: #202630">
      <a-assets id="assets">
        <!-- Optionally place new weapon model (convert your FBX to glb and put in assets/) -->
        <!-- Example: <a-asset-item id="weaponModel" src="./assets/M4A1.glb"></a-asset-item> -->
      </a-assets>
      <!-- LUMIÈRES -->
  <a-entity light="type: ambient; color: #BBB; intensity: 0.4"></a-entity>
  <a-entity id="dirLight" position="2 4 1" light="type: directional; color: #fff; intensity: 1.0; castShadow: true; shadowCameraVisible: false"></a-entity>

      <!-- SOL -->
  <!-- SOL solide (box) pour éviter les traversées -->
  <a-box position="0 -0.05 0" width="40" depth="40" height="0.1" color="#556" material="metalness: 0.2; roughness: 0.8" shadow="receive: true" data-ground></a-box>

      <!-- OBJETS 3D -->
  <!-- Cibles fixes supplémentaires: carré et rond du début -->
  <a-box id="cube" class="target grabbable" position="-3 1.2 -6" depth="1" height="1" width="1" color="#4CC3D9" material="metalness: 0.1; roughness: 0.7" shadow="cast: true; receive: true" data-dyn></a-box>
  <a-sphere id="sphere" class="target grabbable" position="3 1.75 -6" radius="1.25" color="#EF2D5E" material="metalness: 0.2; roughness: 0.5" shadow="cast: true; receive: true" data-dyn></a-sphere>
  <a-cylinder class="grabbable" position="0 2.0 -6" radius="0.5" height="1.5" color="#FFC65D" material="metalness: 0.3; roughness: 0.6" shadow="cast: true; receive: true" data-dyn></a-cylinder>

  <!-- Arme GLB (proche du joueur) -->
  <!-- Gun repositioned closer to initial player start (camera at z=3) -->
  <a-entity id="gun" class="grabbable" position="0.25 1.45 2.6" vr-gun="muzzleOffset: 0 0 -0.35; speed: 12; debug: false" geometry="primitive: box; depth: 0.32; height: 0.14; width: 0.38" material="color: #777; opacity: 0.002; transparent: true">
  <a-entity id="gunModel" gltf-model="./assets/pistol.glb" scale="0.75 0.75 0.75" rotation="0 90 0"></a-entity>
      </a-entity>

  <!-- Spawner de cibles (mêmes emplacements à chaque vague) -->
  <a-entity id="targetsRoot" position="0 0 0" target-spawner="delay: 3000; slots: -4 1.2 -8, -2 1.2 -8, 0 1.2 -8, 2 1.2 -8, 4 1.2 -8, -3 2.2 -10, -1 2.2 -10, 1 2.2 -10, 3 2.2 -10"></a-entity>

  <!-- RIG + CAMÉRA + CONTRÔLEURS -->
  <a-entity id="rig" position="0 1.6 3" thumbstick-move-rotate>
    <a-entity id="head" position="0 0 0" camera="near: 0.01" look-controls="pointerLockEnabled: false" wasd-controls-enabled="false">
      <!-- Simple reticle for desktop aiming (tiny white ring) -->
      <a-entity id="reticle" position="0 0 -1" geometry="primitive: ring; radiusInner: 0.002; radiusOuter: 0.004" material="color: #fff; shader: flat; side: double; opacity: 0.85"></a-entity>
    </a-entity>

  <!-- Contrôleur gauche (Quest 3) -->
  <a-entity id="leftHand" laser-controls="hand: left" raycaster="objects: .grabbable; far: 10" controller-grab="hand: left; radius: 0.65; useTrigger: false">
    <a-sphere radius="0.02" color="#66ccff"></a-sphere>
  </a-entity>

  <!-- Contrôleur droit (Quest 3) -->
  <a-entity id="rightHand" laser-controls="hand: right" raycaster="objects: .grabbable; far: 10" controller-grab="hand: right; radius: 0.65; useTrigger: false">
    <a-sphere radius="0.02" color="#ff9966"></a-sphere>
  </a-entity>
      </a-entity>

      <!-- SKY -->
  <a-sky color="#223"></a-sky>
  <!-- In-VR floating hints -->
  <a-entity position="0 2.2 1.2" text="value: Grip/Squeeze = Prendre | Trigger = Tirer | Stick G = Move | Stick D = Snap Turn; align: center; width: 4" rotation="0 180 0"></a-entity>
    </a-scene>
    <script>
  const scene = document.getElementById('scene');
      const params = new URLSearchParams(location.search);
      const safe = params.get('safe') === '1';
      const debug = params.get('debug') === '1';
  const perf = params.get('perf') === '1';
  const noAutoPick = params.get('noautopick') === '1';
  const muzzleParam = params.get('muzzle'); // format: x,y,z or x y z
  const noPhysics = true; // physique totalement désactivée maintenant
      if (safe) {
        // Disable heavy effects in safe mode
        scene.setAttribute('fog', 'enabled: false');
        scene.setAttribute('renderer', 'shadowMap.enabled: false');
        const dl = document.getElementById('dirLight');
        if (dl) dl.setAttribute('light', 'castShadow: false');
        const dbg = document.getElementById('dbg');
        if (dbg) dbg.style.display = 'none';
      }
      if (perf) {
        // Extreme perf mode: remove shadows & lower pixel ratio
        scene.renderer && (scene.renderer.setPixelRatio(0.7));
        const dl = document.getElementById('dirLight');
        if (dl) dl.setAttribute('light', 'intensity: 0.8; castShadow: false');
        console.log('[Perf] mode actif');
      }
      // (plus de branche physique)
      // Loader SIMPLE : soit ?weaponglb=MonFichier.glb, soit ?weapon=Nom (=> assets/Nom.glb), sinon pistol.glb
      (function(){
        const gm = document.getElementById('gunModel'); if(!gm) return;
        const direct = params.get('weaponglb');
        const named = params.get('weapon');
        let path = './assets/pistol.glb';
        if (direct) path = './assets/' + direct;
        else if (named) path = './assets/' + named + '.glb';
        gm.setAttribute('gltf-model', path);
        console.log('[Weapon] Loading simple path', path);
        if (noAutoPick) { try { const dbg=document.getElementById('dbg'); if(dbg) dbg.textContent=(dbg.textContent+' | autoPick off').trim(); } catch(e){} }
        if (muzzleParam) {
          const parts = muzzleParam.split(/[;, ]+/).map(parseFloat).filter(n=>!isNaN(n));
          if (parts.length===3) {
            const gunEnt=document.getElementById('gun');
            if (gunEnt) gunEnt.setAttribute('vr-gun', 'muzzleOffset: '+parts.join(' '));
          }
        }
        // (physique supprimée: plus d'application dynamic-body)
        gm.addEventListener('model-error', ()=>{
          console.warn('[Weapon] model-error → fallback pistol.glb');
          gm.setAttribute('gltf-model','./assets/pistol.glb');
        });
      })();
      // Relocate gun near player if spawned too far (e.g., missing model place)
      // Reposition simple si loin du joueur (cas rares)
      scene.addEventListener('loaded', ()=>{
        const gun=document.getElementById('gun'); const head=document.getElementById('head');
        if(!gun||!head) return;
        const gp=gun.object3D.getWorldPosition(new THREE.Vector3());
        const hp=head.object3D.getWorldPosition(new THREE.Vector3());
        if(gp.distanceTo(hp)>2.5){
          const forward=new THREE.Vector3(0,0,-1).applyQuaternion(head.object3D.getWorldQuaternion(new THREE.Quaternion()));
          const target=hp.clone().add(forward.multiplyScalar(0.5)); target.y-=0.15;
          gun.setAttribute('position',`${target.x} ${target.y} ${target.z}`);
        }
      });
      if (debug) {
        const gun = document.getElementById('gun');
        if (gun) {
          const v = gun.getAttribute('vr-gun') || {};
          gun.setAttribute('vr-gun', Object.entries(v).map(([k,val])=>`${k}: ${val}`).join('; ') + '; debug: true');
        }
        const right = document.getElementById('rightHand');
        if (right) {
          ['triggerdown','gripdown','squeezestart','selectstart'].forEach(ev=>{
            right.addEventListener(ev, ()=>console.log('[RightHand event]', ev));
          });
        }
      }
      scene.addEventListener('enter-vr', ()=>{
        console.log('[VR] enter-vr');
      });
      scene.addEventListener('loaded', ()=>{
        console.log('[Scene] loaded');
      });
      // Simple frame stall watchdog: if no RAF for >1200ms, show alert tip once
      (function(){
        let last = performance.now();
        let warned = false;
        function tick(){
          const now = performance.now();
            const gap = now - last;
            if (!warned && gap > 1200) {
              warned = true;
              console.warn('[Watchdog] Long frame gap ('+Math.round(gap)+'ms). Essayez ?safe=1 ou ?perf=1 ou ?lite=1');
              const hud = document.getElementById('dbg');
              if (hud) hud.textContent = (hud.textContent + ' | Lag détecté: utiliser ?safe=1 ou ?perf=1').trim();
            }
          last = now;
          requestAnimationFrame(tick);
        }
        requestAnimationFrame(tick);
      })();
    </script>
  </body>
</html>
